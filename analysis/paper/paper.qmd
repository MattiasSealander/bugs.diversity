---
title: "This world is a buggy program: Long-term biodiversity changes in Coleopteran communities on the British Isles"
author:
 - "Mattias Sjölander":
      correspondence: "yes"
      email: mattias.sjolander@arkeologi.uu.se
      orcid: 0000-0003-4530-9784
      institute: [UU]
 - "Nick Schafstall":
      email: nick.schafstall@gmail.com
      orcid: 0000-0002-7781-549X
      institute: []
 - "Scott Cocker":
      email: scott.cocker@geo.su.se
      orcid: 0000-xxxx-xxxx-xxxx
      institute: [SU]
 - "Francesca Pilotto":
      email: philip.buckland@umu.se
      orcid: 0000-0002-2430-0839
      institute: [UmU]      
 - "Philip Buckland":
      email: philip.buckland@umu.se
      orcid: 0000-0002-2430-0839
      institute: [UmU]
institute:
  - UU:
      name: Department of Archaeology and Ancient History and Conservation
      address: Engelska parken, Thunbergsvägen 3H, 751 20 Uppsala, Sweden
  - SU:
      name: Department of Geological Sciences
      address: Stockholm University, Svante Arrhenius väg 8, 114 18 Stockholm, Sweden
  - NINA:
      name: Norwegian Institute for Nature Research, Oslo, Norway
      address: Høgskoleringen 9, 7034 Trondheim, Norway
  - UmU:
      name: Department of Historical, Philosophical and Religious Studies, Umeå University
      address: Humanisthuset, Petrus Laestadius väg, 907 36 Umeå, Sweden
title-block-published: "Last updated"  
date: now
date-format: long
header-includes:
  - \usepackage{koma-script}
format: 
  docx:
    reference-doc: "../templates/template.docx" # Insert path for the DOCX file
execute:
  echo: true
  warning: false  
  message: false
  comment: "#>"
  fig-path: "../figures/"
  fig-dpi: 300
filters:
  - ../templates/scholarly-metadata.lua
  - ../templates/author-info-blocks.lua
  - ../templates/pagebreak.lua
  - ../templates/quarto-landscape.lua
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  palaeoentomology; biodiversity; ecology; Holocene; British Isles
highlights: |
  These are the highlights. 
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->

Keywords: `r rmarkdown::metadata$keywords`

Highlights: `r rmarkdown::metadata$highlights`

<!-- The actual document text starts here: -->

<!-- The following code chunk defines some general settings how code chunks should behave. -->
```{r setup, echo = FALSE}
library(officer)
library(officedown)
library(magick)
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 300,
  encoding = "UTF-8",
  eval.after = "fig-cap"
)
```

<!-- The following function can be used to suppress message outputs -->
```{r}	
quietly <- function(x) {	
  sink(tempfile())	
  on.exit(sink())	
  invisible(force(suppressMessages(x)))	
}	
```

<!-- The following code chunk is used for inline calculations of samples and sites -->
```{r sample-count, results='hide'}
pacman::p_load(tidyverse, IRanges, here, data.table)

# ==============================================================
# 1. Read data
# --------------------------------------------------------------
bugs <- data.table::fread(
  here::here("analysis", "data", "raw_data", "bugs_europe_extraction_samples_20250612.csv")) %>% 
  mutate(sample_id = paste(sample, sample_group, site, sep = "@")) %>%
  as.tibble() 

# ==============================================================
# 2. Filter and prepare data
# --------------------------------------------------------------
time_mat <- bugs %>%
  select(country, latitude, longitude, site, sample_id, sample, age_older, age_younger, context, family_name) %>%
  mutate(age_range = age_older - age_younger,
         mid_age = (age_older + age_younger) / 2,
         region = case_when(
           between(latitude, 49.8, 62.6) & between(longitude, -12.6, 1.8) ~ "UK/Ireland",
           TRUE ~ "Europe")
  ) %>%
  filter(!family_name %in% c("ACANTHOSOMATIDAE","ANTHOCORIDAE", "APHALARIDAE", "APHIDOIDEA", "AUCHENORRHYNCHA", "BIBIONIDAE",
                             "BRACHYCENTRIDAE", "CALOPTERYGIDAE", "CERCOPIDAE", "CHIRONOMIDAE", "CICADELLIDAE", "CICADOMORPHA",
                             "CIXIIDAE", "CORIXIDAE", "CYCLORRHAPHA", "CYDNIDAE", "DELPHACIDAE", "DERMAPTERA", "DIPTERA", "FORFICULIDAE",
                             "FORMICIDAE", "FULGOROMORPHA", "GERRIDAE", "GLOSSOSOMATIDAE", "GOERIDAE", "HEBRIDAE", "HEMIPTERA",
                             "HETEROPTERA", "HOMOPTERA", "HYDROPSYCHIDAE", "HYDROPTILIDAE", "HYMENOPTERA", "LEPIDOPTERA", "LEPIDOSTOMATIDAE",
                             "LEPTOCERIDAE", "LIMNEPHILIDAE", "LYGAEIDAE", "MEMBRACIDAE", "MICROPHYSIDAE", "MICROSPORIDAE", "MIRIDAE",
                             "MOLANNIDAE", "NABIDAE", "NEMATOCERA", "NEMOURIDAE", "ODONATA", "PARASITICA", "PENTATOMIDAE", "PHRYGANEIDAE",
                             "POLYCENTROPIDAE", "PSYCHOMYIIDAE", "PSYLLIDAE", "RAPHIDIIDAE", "SALDIDAE", "SCUTELLERIDAE", "SERICOSTOMATIDAE",
                             "SIALIDAE", "TRICHOPTERA", "THYREOCORIDAE", "TINGIDAE", "TIPULIDAE", "TRIOPSIDAE", "TRIOZIDAE"),
         context == "Stratigraphic sequence",
         sample != "BugsPresence",
         age_range <= 2000,
         between(mid_age, -500, 16000)) %>%
  distinct() %>%
  select(region, site, sample_id, age_younger, age_older) %>%
  dplyr::rename(start = age_younger, end = age_older)

# Check for reversed ranges
if (any(time_mat$start > time_mat$end)) {
  time_mat <- time_mat %>%
    mutate(start = pmin(start, end), end = pmax(start, end))
}


# ==============================================================
# 3. Define 500-year temporal bins
# --------------------------------------------------------------
# Bins are used for assigning samples to time intervals.
# ==============================================================
age_bins <- tibble(
  start = c(-500, seq(1, 15501, by = 500)),
  end   = seq(0, 16000, by = 500)
)

# ==============================================================
# 4. Define 500-year temporal bins
# ==============================================================
range <- tibble(
  start = c(-500, seq(1, 15501, by = 500)),
  end   = seq(0, 16000, by = 500)
)

# ==============================================================
# 5. Identify overlapping samples with time bins
# ==============================================================
query <- IRanges(start = time_mat$start, end = time_mat$end)
subject <- IRanges(start = range$start, end = range$end)

intersection <- findOverlaps(query, subject, type = "any")
if (length(intersection) == 0) stop("No overlaps found. Check age ranges and bin definitions.")

# ==============================================================
# 6. Merge sample metadata with bin assignments
# ==============================================================
hits <- tibble(
  region = time_mat$region[queryHits(intersection)],
  site = time_mat$site[queryHits(intersection)],
  sample_id = time_mat$sample_id[queryHits(intersection)],
  bin_start = range$start[subjectHits(intersection)],
  bin_end   = range$end[subjectHits(intersection)]
)

# ==============================================================
# 7. Prepare sample and site counts
# ==============================================================
# Unique sites Europe
sites_eu <- 
  hits %>%
  select(site) %>% 
  distinct()

# Unique sites UK/Ireland
sites_brit <- 
  hits %>%
  filter(region == "UK/Ireland") %>% 
  select(site) %>% 
  distinct()

# Unique samples UK/Ireland
samples_brit <-  
  hits %>%
  filter(region == "UK/Ireland") %>% 
  select(sample_id) %>% 
  distinct()

# Late Glacial samples UK/Ireland
LG_samples <- hits %>%
  filter(region == "UK/Ireland",
         bin_end >= 11700 & bin_start <= 16000) %>% 
  distinct(sample_id)

# Early Holocene samples UK/Ireland
EH_samples <- hits %>%
  filter(region == "UK/Ireland",
         bin_end >= 7000 & bin_start <= 11699) %>%
  distinct(sample_id)
  
# Mid-Holocene samples UK/Ireland
MH_samples <- hits %>%
  filter(region == "UK/Ireland",
         bin_end >= 5000 & bin_start <= 6999) %>% 
  distinct(sample_id)

# Late Holocene samples UK/Ireland
LH_samples <- hits %>%
  filter(region == "UK/Ireland",
         bin_end >= 0 & bin_start <= 4999) %>% 
  distinct(sample_id)
```

# Introduction

In recent decades there have been a proliferation of studies applying a “Big Data” approach [@hoffman_etal2021; @pollo_etal2025; @xing_fayle2021]. These systematic reviews and meta-analyses model climate change [@lenoir_svenning2015], environmental dynamics [@morrison_etal2021; @seidl_etal2017], and human impact at multi-region to global scales [@schmid_schiffels2023; @stephens_etal2019; @woodbridge_etal2021]. This is largely facilitated through advances in remote sensing, the expansion of biodiversity databases (e.g., GBIF; <https://www.gbif.org/>), improved open data policies [@burgelman_etal2019], and the growth of citizen science platforms [@buckland_sjolander2022; @cavender_bares_etal2022; @fraisl_etal2022; @page_etal2015; @ramachandran_etal2021; @tresp_etal2016].

Access to high-quality aggregated datasets with paleo-temporal coverage is instrumental to address some of the more pressing questions related to insect biodiversity, such as the modern-day decline in insect biomass and loss of pollinating insect species [@hallman_etal2017; @muller_etal2024; @powney_etal2019; @schachat_labandeira2020; @vanklink_etal2020]. This decline has largely been attributed to human influence and the intensification of agriculture [@habel_etal2019; @raven_wagner2021], however, there is a need for further exploration of the potential drivers of insect declines [@sanchez_bayo_wyckhuys2019]. To do so, it is important to have a good understanding of insect biodiversity before modern-day extensive human impact, as well as how this relationship has developed across millennia. Anthropogenic influence has not always been a net-negative for insects, as evidenced by synanthropic species benefiting from man-made environments [@panagiotakopulu_buckland2017]. The development of agriculture, with increased sedentariness and urbanisation, also provided a suitable environment for a wide array of fauna, as well as enabled their distribution to the far corners of the world [e.g. @panagiotakopulu_etal2007; @smith_etal2020].

The evolution of the European landscape, and the intensification of human impact throughout the Holocene, have long been central themes in palynological research [@giesecke_etal2019; @mitchell2005; REFS]. Leveraging extensive quantitative pollen datasets—accessible via the European Pollen Database (EPD) now integrated into Neotoma (https://neotomadb.org)—advanced land-cover reconstructions (e.g. REVEALS, LOVE) provide a dynamic perspective on forest structure and its transformation over the past 10 ka [@githumbi_etal2022]. The integration of palaeoentomological evidence can provide valuable environmental information not easily detected in the pollen record, such as open-ground or agropastoral indicators, as well more direct evidence of human presence via synanthropic species [@woodbridge_etal2021; panagiotakopulu_buckland2017]. 

The British Isles is well represented in European palaeoentomological datasets and the English-language literature [@buckland2014] fig-sites-overview. Despite the accessibility of these data [@buckland_etal2018; @williams_etal2018], large-scale quantitative approaches to palaeoentomological research remain scarce. Studies tend to focus on qualitative syntheses of faunal developments or limited inter-site comparisons. Whitehouse’s [-@whitehouse2006] review of Lateglacial–Holocene forest beetle assemblages documents their introduction, continuity, and extirpation on the British Isles. However, the paucity of Early Holocene data hampers detailed reconstruction of the transition from the light-forest Lateglacial landscape to early Holocene woodland [@buckland2014: 275; @whitehouse2006: 1757-1758]. Palaeoentomological data seem to indicate that forests developed early in the Holocene, reaching their maximum extent around 7–6 ka BP [@coope1990]. This pattern aligns with recent pollen-based land-cover reconstructions [@githumbi_etal2022], which also highlight persistent open landscapes in northern Scotland—a region notably lacking palaeoentomological data [whitehouse2006: 1775] fig-sites-overview.

Synanthropic insects have been recovered from archaeological sites dating as far back as the Mesolithic (ca. 11 ka BP). Early synanthropic taxa, however, occupied a broad range of habitats and likely originated from natural contexts, as suggested by Smith et al. [@smith_etal2020]. By the Late Bronze Age period (ca. 3 ka BP), new synanthropic species associated with pasture and livestock management appear, providing clearer evidence of human influence on the landscape [@woodbridge_etal2021]. This development coincides with a marked reduction in forest cover from the mid-Holocene onwards, as indicated by pollen-based studies [e.g. @githumbi_etal2022], and with the replacement of forest beetle taxa by species indicative of more managed environments [@whitehouse2006]. From ca. 2 ka BP onwards the synanthropic fauna show strong urban signals [@smith_etal2020], along with the introduction of pests related to the storage of grain [@panagiotakopulu_buckland2017].

Pilotto et al.s’ [-@pilotto_etal2022] study is a recent example of a large-scale exploratory approach to insect data. The analysis is based on beetle data recovered from palaeoecological contexts in NW Europe and uses network clustering. The model was run on both the species specific data, as well as the interpreted habitat information [Bugs ecocodes; see @buckland2007]. The results reaffirmed key transitional periods as being 10 ka BP and 3.5 ka BP when considering species information, however, further transitions were identified when considering habitat information. These suggest changes in the environment that impact the faunal composition, which necessitate further investigation.
 

# Aims

The aim of this paper is to study biodiversity trends of Coleoptera during periods of biotic transitions in the area of the United Kingdom (UK) and Ireland during the Late Glacial - Holocene period. Outside of systematic reviews of digitized and available data [e.g. @buckland2014; REF], large-scale palaeoenvironmental studies of subfossil insect data are rare. This paper presents a unique analysis and evaluation of biodiversity trends of the data available in the currently largest database of subfossil finds of Coleoptera, the Strategic Environmental Archaeology Database (SEAD).  


# Materials and Methods

The analysis is based on data retrieved from the BugsCEP constituent database (https://bugscep.com) [@buckland_buckland2006] of the open access Strategic Environmental Archaeology Database (SEAD; [sead.se](https://sead.se)) [@buckland_etal2018]. The study area includes the United Kingdom and Ireland during the Late Glacial - Holocene period, which has good coverage within the database [browser.sead.se/palaeoentomology](https://browser.sead.se/palaeoentomology). The study includes a total of `r nrow(sites_eu)` sites from which `r nrow(samples_brit)` samples have been collected. All of the samples come from natural deposits, with little to no signs of direct human influence (e.g. peat bogs, lakes) (fig-sites-overview).

SEAD includes data generated by a variation of dating methods (e.g. radiometric, archaeological periods), with different levels of uncertainty, and have been harmonised to years Before Present (BP) to enable aggregated spatiotemporal analysis (REF). Samples that feature large age ranges, whether the result of long periods of accumulation or uncertainty, contribute noise to the data and make it difficult to discern short-term changes. Therefore, the dataset was filtered temporally, according to the process outlined in [@pilotto_etal2022]. Any samples with a mid-point that dated older than 16 000 years BP, and with an age range larger than 2 000 years, were excluded from the study. In adhering to the same filtering process, it likewise makes comparisons with the results from Pilotto et al.’s study of biotic transitions in Coleopteran communities possible. 

Analysis was performed in the R statistical open-source software [ver. 4.4.2; @rcore2021]. For temporal comparisons the study period was divided into 500-year bins and each sample was assigned to the bins they intersect using IRanges() from the Bioconductor package [@lawrence_etal2013]. Alpha, beta and gamma diversity metrics were calculated using a suite of ecological R packages. Each sample represents a single community, meaning that alpha diversity is defined on a sample basis. Gamma diversity represents the summed diversity of all samples that intersect a 500-year bin. Beta diversity, i.e. the change across time, is primarily analysed based on the aggregated community data (i.e. comparisons between 500-year bins). 

Diversity metrics include species richness, Shannon and Simpson diversity, and species turnover. Species richness was calculated using the vegan package [@oksanen_etal2024].  with remaining alpha and gamma metrics calculated using the entropart package [@marcon_herault2015]. The entropart package offers a number of estimation bias-correction methods to address mathematical issues with certain indexes (e.g. Shannon) and unobserved species. For this study the default unveiled estimators (“UnveilJ”) based on @chao_jost2015 and @marcon2015 were used, which includes jackknife for species richness estimation. Species turnover was calculated using Rank Abundance Curves (RAC) from the *codyn* package [@hallett_etal2020].

The analysis compares both raw abundances and standardized values. Rarefaction is a common standardization method for samples with variable sample depth in ecology [@sanders1968]. Effectively, individuals are discarded randomly from samples larger than the threshold set by the analyst. This method has received criticism, however, for its poor reproducibility and issues related to unequal sample sizes [@mcmurdie_holmes2014; @willis2019]. An alternative to rarefaction is Scaling with Ranked Subsampling *SRS), which like rarefaction scales the dataset based on a threshold set by the analyst, but preserves the population structure [@beule_karlovsky2020]. SRS was chosen as the primary standardization method for this study.  

In both rarefaction and SRS a threshold (Cmin) must be set for the new sample depth (abundance of individuals). Typically the smallest sample is used as the threshold, which would be unsuitable in this case as that is 1 individual. The threshold needs to be high enough to produce a suitably diverse community, but low enough that the size of the dataset is not impacted too severely. Most samples feature between 5 – 10 individuals, meaning a higher threshold will exclude a large portion of the dataset. With this in mind, Cmin was set to 10 for the analysis. Standardization was performed using the *SRS* package [@heidrich_etal2021].

The RAC function generates visualisations that compare the change in number and abundance of species between pairs of years (in this case 500-year bins) [@avolio_etal2019]. That is to say, each time bin is compared with the preceding one during analysis. RAC calculates five different metrics: species richness, evenness, rank change (change in species rank order), species turnover: gains, species turnover: losses. 

Environmental reconstructions were performed according to the BugsCEP procedure [@buckland2007: 101-117]. The data was summarised for each 500-year bin a sample intersected and standardised across each habitat type. The standardization shows each habitat as a proportion of the sum of environments included in the analysis (%SumRep). It is important to note that each taxa may be counted for more than one habitat. Two separate reconstructions were generated and evaluated; one that is based on presence only counts of taxa and one that is abundance weighted. 


# Results

## Spatiotemporal Distribution
 \linebreak

```{r}
#| label: fig-sites-overview
#| cache: true
#| fig.align: "center"
#| out.height: "6in"
#| out.width: "6in"
#| fig-cap: !expr paste("Distribution of sites with samples from palaeoecological contexts within Europe (n = ", nrow(sites_eu), ") filtered to the temporal range of the study. Most of the sites (n =", nrow(sites_brit), ") are located within the study area of the United Kingdom and Ireland.")

# Run subscript
quietly(source(here::here("analysis", "paper", "001-sites-overview.R"), encoding = "UTF-8"))
# Import figure
knitr::include_graphics(here::here("analysis", "figures", "001-sites-overview.jpg"), error = FALSE)
```


 \linebreak

The Coleopteran dataset in SEAD exhibits a pronounced geographical bias toward northwestern Europe, particularly the British Isles (Figure 1) [@buckland2014]. Of the `r nrow(sites_eu)` European sites meeting the selection criteria, approximately `r round((nrow(samples_brit) / nrow(sites_eu)) * 100)`% are located within the United Kingdom and Ireland. Temporally, the dataset displays a bimodal distribution, with the Lateglacial and Mid-to-Late Holocene periods more comprehensively represented across all sampling levels (site, sample, and taxon abundance) @fig-sample-dates. In contrast, sampling coverage for the 10 ka – 6 ka BP period remains comparatively limited.

 \linebreak

```{r}
#| label: fig-sample-dates
#| cache: true
#| fig.align: "center"
#| out.height: "7in"
#| out.width: "6.5in"
#| fig-cap: "a) Summary of sites, samples and total abundance for each 500-year bin between 16 000 BP and the modern day. The data is bimodally distributed across the study period, with peaks around the Late glacial and the last ~ 5 000 years. The decrease in datasets that cover 10 000 – 6 000 BP highlights a need for research and data submissions. b) Sample age ranges for the samples from the United Kingdom and Ireland, ordered from oldest to youngest. "

# Run subscript
quietly(source(here::here("analysis", "paper", "001-sample-date-distribution.R"), encoding = "UTF-8"))
# Import figure
knitr::include_graphics(here::here("analysis", "figures", "001-sample-site-abundance-summary.jpg"), error = FALSE)
```

 \linebreak

The observed species richness (raw values) largely mirrors the abundance patterns @fig-sample-dates\ignorespaces a, with peaks around 11.5 ka and 3.5 ka BP (Figure 3). The estimated coverage, i.e. the probability that an individual belongs to a known species in the 500 yr bin, is the highest during the Lateglacial period (~ 0.8 - 0.9). Around 10 ka BP there is a sharp decline in coverage, with the remaining parts of the Early Holocene period characterized by some variation. The Mid-to-Late Holocene period features overall lower coverage values than preceding periods with a strong decline during the last 1 ka. 

 \linebreak

```{r}
#| label: fig-coverage
#| cache: true
#| fig.align: "center"
#| out.height: "7.5in"
#| out.width: "5.5in"
#| fig-cap: "Coverage and richness estimation using bias-correction. Observed Richness is the total abundance of unique species found within each 500-year bin. Coverage estimates the completeness of the 500-year bin, i.e. the proportion of individuals belonging to the observed species. Estimated Richness shows the extrapolated richness using Chao (1984) correction."

# Run subscript
quietly(source(here::here("analysis", "paper", "002-richness-estimation.R"), encoding = "UTF-8"))
# Import figure
knitr::include_graphics(here::here("analysis", "figures", "002-richness-estimation.jpg"), error = FALSE)
```

 \linebreak

# Alpha Diversity

As can be seen in @fig-alpha, there is a decrease in sample-based diversity over the course of the Lateglacial period. This is reflected in both the raw and standardized data, with the latter showing a more gradual decrease following 16 ka BP. Alpha diversity remains somewhat stable until ca. 10 ka BP, when both Shannon and Simpson values indicate an increase in diversity. Following this increase the raw abundance data indicates a significant spike in diversity that peaks around 8 ka BP, before it begins to decline once more. Standardized values, however, quickly declines following 10 ka BP and remains low until the later parts of the Mid-Holocene.

 \linebreak

```{r}
#| label: fig-alpha
#| cache: true
#| fig.align: "center"
#| out.height: "7.5in"
#| out.width: "5.5in"
#| fig-cap: "Hill numbers of alpha diversity (effective number of species) for each 500-year time bin based on raw abundance values. The value represents the mean diversity of all samples (weighted by abundance) that intersect a time bin. Richness = effective species richness, Shannon = effective number of common species, Simpson = effective number of abundant species."

# Run subscript
#quietly(source(here::here("analysis", "paper", "003-alpha-diversity.R"), encoding = "UTF-8"))
# Import figure
knitr::include_graphics(here::here("analysis", "figures", "003-alpha-diversity.jpg"), error = FALSE)
```

 \linebreak

Around 6 ka BP both raw and standardized values show increasing diversity throughout the remainder of the Mid-Holocene period. However, entering the Late Holocene the raw and standardized data once more differentiates. The raw Shannon values peak at ca. 4 000 ka BP, before richness in both orders begin a decline in diversity that continues throughout the Late Holocene. Standardized values, however, show a delayed pattern than compared to the raw data. Diversity drops following the Mid-Holocene and does not indicate a reversal of this trend until ca. 3.5 ka BP. Diversity continues to rise for about 1 ka before it once more enters a period of decline which lasts until the modern-day.

# Gamma Diversity

The gamma diversity for the raw and standardized data largely describes similar changes in diversity for the British Isles [@fig-gamma]. One major difference, however, can be seen in the Lateglacial period. The raw data shows a steady increase in diversity across both orders, with a slight decrease at 13 ka BP. The standardized data, however, show similarly high values around 16 ka BP as was seen in the alpha diversity. The main difference being that the gamma diversity has less evenness, dominated by higher Simpson values. Both Shannon and Simpson values decline over the course of the Lateglacial period, reaching their lowest values for the period at 13 ka BP.

After 13 ka BP both raw and standardized data shows a period of diversity increase up until ca. 10 ka BP [@fig-gamma]. Although the raw data shows less evenness following 11.5 ka BP, both Shannon and Simpson values in the SRS data follow each other during the initial part of the Early Holocene. Following 10 ka BP there is a drastic decline in diversity values up until ca. 8.5 ka BP, after which they begin recovering once more. Throughout the Mid-Holocene, and first parts of the Late Holocene, both raw and standardized values follow a similar pattern of diversity increase. There is a small decline in the number of abundant species around 4.5 ka BP, but otherwise the raw data shows a steady increase until ca. 3 ka BP, after which it enters a period of decline. The SRS values largely follow a similar trend, but with a slightly faster decline in Simpson values following 3.5 ka BP. 

 \linebreak

```{r}
#| label: fig-gamma
#| cache: true
#| fig.align: "center"
#| out.height: "7.5in"
#| out.width: "5.5in"
#| fig-cap: " Hill numbers of gamma diversity (effective number of species) for each 500-year time slice, calculated on both raw abundance and SRS standardized values. Each value represents the total diversity (samples abundance weighted) for each time bin. Shannon = effective number of common species, Simpson = effective number of abundant species."

# Run subscript
quietly(source(here::here("analysis", "paper", "003-gamma-diversity.R"), encoding = "UTF-8"))
# Import figure
knitr::include_graphics(here::here("analysis", "figures", "003-gamma-diversity.jpg"), error = FALSE)
```

 \linebreak

# Species Turnover

 \linebreak

```{r}
#| label: fig-rac
#| cache: true
#| fig.align: "center"
#| out.height: "7.5in"
#| out.width: "6.5in"
#| fig-cap: "Rank Abundance Curves (RAC) calculated on raw values from the British Isles (Avolio et al. 2019). Calculations are made on the summed abundances of all samples that intersect a 500-year time bin. In RAC the change in five parameters of community change (Species richness, Rank abundance, Evenness, Species gain, Species loss) is analysed between two time points."

# Run subscript
quietly(source(here::here("analysis", "paper", "005-rank-abundance-curves.R"), encoding = "UTF-8"))
# Import figure
knitr::include_graphics(here::here("analysis", "figures", "005-rank-abundance-curves.jpg"), error = FALSE)
```

 \linebreak

A summary of the species turnover can be seen in @fig-div-comparison. As noted in the gamma diversity [@fig-gamma], the start of the study period features low evenness with a high appearance of new species. After ca. 15.5 ka BP, however, there is little change in the summary metrics aside from a small increase in the evenness. Around 10 ka BP there is a significant loss in species richness, along with an increase in evenness and species reordering. This coincides with the decline in Shannon values for gamma diversity based on raw abundance data [@fig-gamma], along with an increase in Simpson richness. This suggests a loss of rarer species, leading to an increased evenness, along with a possible reordering of the dominant species.

From 10 ka BP on the RAC shows some variation during the Early Holocene [@fig-div-comparison], but no clear patterns of interpretation. The most significant change is a drop in the influx of new species at 8.5 ka BP, which coincides with the lowest Shannon and Simpson values in Figure 6. Around 6 ka BP there is a marked increase in species richness, which also leads to a loss in evenness and rank reordering. Considering the difference in magnitude between Shannon and Simpson values for the gamma diversity at this same time, this may also be the case of a wider pool of unevenly distributed species. Following this shift there is a period of some stability when entering the Late Holocene period. The previously noted increase in gamma diversity at ca. 3 ka BP, followed by a period of diversity loss [@fig-gamma], can also be traced in the RAC [@fig-rac]. An increase in species richness and lowered evenness is followed by some instability, with shifting richness increase and decrease. A clear change occurs at 1.5 ka BP, however, with a spike in species loss, leading to a smaller but more evenly distributed species pool, which continues the trend of a loss in diversity until the modern-day.

::: {.landscape}

```{r}
#| label: fig-div-comparison
#| cache: true
#| fig.align: "center"
#| out.height: "10in"
#| out.width: "14in"
#| fig-cap: "A comparison of beetle diversity and habitat reconstruction against pollen diversity for the British Isles. Relative temperature change based on Greenland oxygen isotope data included as a reference (Seierstad et al. 2014)."

quietly(source(here::here("analysis", "paper", "003-gamma-diversity.R"), encoding = "UTF-8"))
quietly(source(here::here("analysis", "paper", "006-ecocodes-britain.R"), encoding = "UTF-8"))
quietly(source(here::here("analysis", "paper", "007-oxygen-corr-script.R"), encoding = "UTF-8"))
quietly(source(here::here("analysis", "paper", "pollen_richness_wip.R"), encoding = "UTF-8"))

eco_results <- results_filtered %>% 
  filter(method == "Abundance-weighted")

p_eco <- ggplot(eco_results, aes(x = bin, y = value, fill = ecocode)) +
  geom_bar(
    stat = "identity",
    position = "stack",
    alpha = 0.9,
    just = 0
    ) +
  scale_fill_manual(values = colors, name = "Habitat") +
  guides(fill = guide_legend(nrow = 5, reverse = TRUE)) +
  scale_x_reverse(breaks = time_breaks, labels = time_breaks) +  
  labs(
    title = "Habitat reconstruction",
    subtitle = "Abundance-weighted",
    x = "",
    y = "%SumRep"
  ) +
  coord_flip() +
  theme_bw() +
  theme(
    plot.title    = element_text(size = 16, face = "bold", colour = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 12, face = "bold"),
    strip.text = element_text(size = 14, face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12),
  ) +
  labs(y = "%SumRep", x = "")


# Bottom legend should show only FILL
legend_bottom_src <- p_shan +
  guides(
    fill     = guide_legend(ncol = 1),  # vertical stack; adjust to taste
    shape    = "none",                  # <-- suppress SHAPE here
    linetype = "none",
  ) +
  theme(legend.position = "bottom",
        legend.title = element_text(size = 12, face = "bold"))

# --- 2) Extract the two legends ---
legend_bottom <- cowplot::get_legend(legend_bottom_src)
eco_bottom <- cowplot::get_legend(p_eco)


p_shan2 <- p_shan +
  labs(title = "Gamma Diversity",
         subtitle = "Shannon") +
    guides(
    shape    = guide_legend(nrow = 1, title = NULL, position = "top"),  # center-friendly one-row legend
    linetype = guide_legend(nrow = 1, title = NULL, position = "top"),
    fill     = "none",               # <-- suppress FILL here
  ) +
  theme(plot.subtitle    = element_text(size = 12, colour = "black"))

p_simp2 <- p_simp +
    labs(title = "",
         subtitle = "Simpson") +
  theme(legend.position = "none",
        plot.subtitle    = element_text(size = 12, colour = "black"))

p_eco2 <- p_eco +
  theme(legend.position = "none")

left_group <- (p_shan2 + p_simp2 + p_eco2) +
  plot_layout(ncol = 3)

library(gtable)
# Trim extraneous whitespace from the legend gtable
legend_bottom <- gtable::gtable_trim(legend_bottom)

# Compose WITHOUT heavy alignment on grobs (avoid "hv" for legends)
panels <- cowplot::plot_grid(
  legend_bottom, eco_bottom,
  nrow = 1,
  rel_widths = c(0.30, 0.70),   # tweak to your taste
  align = "h",                  # horizontal only (safer for grobs)
  axis  = "tb"                  # top/bottom axes only if needed
)

right_group <- (p_pollen + theme(legend.position = "top")) + p_d18 +
  plot_layout(ncol = 2, widths = c(1, .9))


combined <- (left_group + right_group) + plot_layout(nrow = 1, ncol = 4, widths = c(.5, .5, .5, 1))  

combined <- combined / panels + plot_layout(heights = c(1, .2))


# Save combined figure
ggsave(
  filename = "007-diversity-comparison.jpg",
  plot     = combined,
  path     = fig_dir,
  width = 50,
  height = 40,
  units = "cm",
  dpi = 500
)

# Import figure
knitr::include_graphics(here::here("analysis", "figures", "007-diversity-comparison.jpg"), error = FALSE)
```
:::

# Discussion
<!-- The following line inserts a page break  -->
\newpage

# Conclusion

# Acknowledgements

\newpage

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies:

```{r}
#| label: colophon
#| cache: false

# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
