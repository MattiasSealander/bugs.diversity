---
title: "This world is a buggy program: Long-term biodiversity changes in Coleopteran communities on the British Isles"
author:
 - "Mattias Sjölander":
      correspondence: "yes"
      email: mattias.sjolander@arkeologi.uu.se
      orcid: 0000-0003-4530-9784
      institute: [UU]
 - "Nick Schafstall":
      email: nick.schafstall@gmail.com
      orcid: 0000-0002-7781-549X
      institute: []
 - "Scott Cocker":
      email: scott.cocker@geo.su.se
      orcid: 0000-xxxx-xxxx-xxxx
      institute: [SU]
 - "Francesca Pilotto":
      email: philip.buckland@umu.se
      orcid: 0000-0002-2430-0839
      institute: [UmU]      
 - "Philip Buckland":
      email: philip.buckland@umu.se
      orcid: 0000-0002-2430-0839
      institute: [UmU]
institute:
  - UU:
      name: Department of Archaeology and Ancient History and Conservation
      address: Engelska parken, Thunbergsvägen 3H, 751 20 Uppsala, Sweden
  - SU:
      name: Department of Geological Sciences
      address: Stockholm University, Svante Arrhenius väg 8, 114 18 Stockholm, Sweden
  - NINA:
      name: Norwegian Institute for Nature Research, Oslo, Norway
      address: Høgskoleringen 9, 7034 Trondheim, Norway
  - UmU:
      name: Department of Historical, Philosophical and Religious Studies, Umeå University
      address: Humanisthuset, Petrus Laestadius väg, 907 36 Umeå, Sweden
title-block-published: "Last updated"  
date: now
date-format: long
header-includes:
  - \usepackage{koma-script}
format: 
  docx:
    reference-doc: "../templates/template.docx" # Insert path for the DOCX file
execute:
  echo: true
  warning: false  
  message: false
  comment: "#>"
  fig-path: "../figures/"
  fig-dpi: 300
filters:
  - ../templates/scholarly-metadata.lua
  - ../templates/author-info-blocks.lua
  - ../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/journal-of-archaeological-science.csl" # Insert path for the bib-style
abstract: |
  Text of abstract
keywords: |
  palaeoentomology; biodiversity; ecology; Holocene; Europe
highlights: |
  These are the highlights. 
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

<!-- With the following code you can access and display values from the yml header above. -->

Keywords: `r rmarkdown::metadata$keywords`

Highlights: `r rmarkdown::metadata$highlights`

<!-- The actual document text starts here: -->

<!-- The following code chunk defines some general settings how code chunks should behave. -->
```{r setup, echo = FALSE}
library(officer)
library(officedown)
library(magick)
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 300,
  encoding = "UTF-8",
  eval.after = "fig-cap"
)
```

<!-- The following function can be used to suppress message outputs -->
```{r}	
quietly <- function(x) {	
  sink(tempfile())	
  on.exit(sink())	
  invisible(force(suppressMessages(x)))	
}	
```

<!-- The following code chunk is used for inline calculations of samples and sites -->
```{r sample-count, results='hide'}
pacman::p_load(tidyverse, IRanges, here, data.table)

# ==============================================================
# 1. Read data
# --------------------------------------------------------------
bugs <- data.table::fread(
  here::here("analysis", "data", "raw_data", "bugs_europe_extraction_samples_20250612.csv")) %>% 
  mutate(sample_id = paste(sample, sample_group, site, sep = "@")) %>%
  as.tibble() 

# ==============================================================
# 2. Filter and prepare data
# --------------------------------------------------------------
time_mat <- bugs %>%
  select(country, latitude, longitude, site, sample_id, sample, age_older, age_younger, context, family_name) %>%
  mutate(age_range = age_older - age_younger,
         mid_age = (age_older + age_younger) / 2,
         region = case_when(
           between(latitude, 49.8, 62.6) & between(longitude, -12.6, 1.8) ~ "UK/Ireland",
           TRUE ~ "Europe")
  ) %>%
  filter(!family_name %in% c("ACANTHOSOMATIDAE","ANTHOCORIDAE", "APHALARIDAE", "APHIDOIDEA", "AUCHENORRHYNCHA", "BIBIONIDAE",
                             "BRACHYCENTRIDAE", "CALOPTERYGIDAE", "CERCOPIDAE", "CHIRONOMIDAE", "CICADELLIDAE", "CICADOMORPHA",
                             "CIXIIDAE", "CORIXIDAE", "CYCLORRHAPHA", "CYDNIDAE", "DELPHACIDAE", "DERMAPTERA", "DIPTERA", "FORFICULIDAE",
                             "FORMICIDAE", "FULGOROMORPHA", "GERRIDAE", "GLOSSOSOMATIDAE", "GOERIDAE", "HEBRIDAE", "HEMIPTERA",
                             "HETEROPTERA", "HOMOPTERA", "HYDROPSYCHIDAE", "HYDROPTILIDAE", "HYMENOPTERA", "LEPIDOPTERA", "LEPIDOSTOMATIDAE",
                             "LEPTOCERIDAE", "LIMNEPHILIDAE", "LYGAEIDAE", "MEMBRACIDAE", "MICROPHYSIDAE", "MICROSPORIDAE", "MIRIDAE",
                             "MOLANNIDAE", "NABIDAE", "NEMATOCERA", "NEMOURIDAE", "ODONATA", "PARASITICA", "PENTATOMIDAE", "PHRYGANEIDAE",
                             "POLYCENTROPIDAE", "PSYCHOMYIIDAE", "PSYLLIDAE", "RAPHIDIIDAE", "SALDIDAE", "SCUTELLERIDAE", "SERICOSTOMATIDAE",
                             "SIALIDAE", "TRICHOPTERA", "THYREOCORIDAE", "TINGIDAE", "TIPULIDAE", "TRIOPSIDAE", "TRIOZIDAE"),
         context == "Stratigraphic sequence",
         sample != "BugsPresence",
         age_range <= 2000,
         between(mid_age, -500, 16000)) %>%
  distinct() %>%
  select(region, site, sample_id, age_younger, age_older) %>%
  dplyr::rename(start = age_younger, end = age_older)

# Check for reversed ranges
if (any(time_mat$start > time_mat$end)) {
  time_mat <- time_mat %>%
    mutate(start = pmin(start, end), end = pmax(start, end))
}


# ==============================================================
# 3. Define 500-year temporal bins
# --------------------------------------------------------------
# Bins are used for assigning samples to time intervals.
# ==============================================================
age_bins <- tibble(
  start = c(-500, seq(1, 15501, by = 500)),
  end   = seq(0, 16000, by = 500)
)

# ==============================================================
# 4. Define 500-year temporal bins
# ==============================================================
range <- tibble(
  start = c(-500, seq(1, 15501, by = 500)),
  end   = seq(0, 16000, by = 500)
)

# ==============================================================
# 5. Identify overlapping samples with time bins
# ==============================================================
query <- IRanges(start = time_mat$start, end = time_mat$end)
subject <- IRanges(start = range$start, end = range$end)

intersection <- findOverlaps(query, subject, type = "any")
if (length(intersection) == 0) stop("No overlaps found. Check age ranges and bin definitions.")

# ==============================================================
# 6. Merge sample metadata with bin assignments
# ==============================================================
hits <- tibble(
  region = time_mat$region[queryHits(intersection)],
  site = time_mat$site[queryHits(intersection)],
  sample_id = time_mat$sample_id[queryHits(intersection)],
  bin_start = range$start[subjectHits(intersection)],
  bin_end   = range$end[subjectHits(intersection)]
)

# ==============================================================
# 7. Prepare sample and site counts
# ==============================================================
# Unique sites Europe
sites_eu <- 
  hits %>%
  select(site) %>% 
  distinct()

# Unique sites UK/Ireland
sites_brit <- 
  hits %>%
  filter(region == "UK/Ireland") %>% 
  select(site) %>% 
  distinct()

# Unique samples UK/Ireland
samples_brit <-  
  hits %>%
  filter(region == "UK/Ireland") %>% 
  select(sample_id) %>% 
  distinct()

# Late Glacial samples UK/Ireland
LG_samples <- hits %>%
  filter(region == "UK/Ireland",
         bin_end >= 11700 & bin_start <= 16000) %>% 
  distinct(sample_id)

# Early Holocene samples UK/Ireland
EH_samples <- hits %>%
  filter(region == "UK/Ireland",
         bin_end >= 7000 & bin_start <= 11699) %>%
  distinct(sample_id)
  
# Mid-Holocene samples UK/Ireland
MH_samples <- hits %>%
  filter(region == "UK/Ireland",
         bin_end >= 5000 & bin_start <= 6999) %>% 
  distinct(sample_id)

# Late Holocene samples UK/Ireland
LH_samples <- hits %>%
  filter(region == "UK/Ireland",
         bin_end >= 0 & bin_start <= 4999) %>% 
  distinct(sample_id)
```

# Introduction

The last decades have seen a sharp increase in large-scale synthesis studies utilizing existing “Big Data” [@hoffman_etal2021; @pollo_etal2025; @xing_fayle2021], providing systematic reviews and meta-analyses that model multi-regional to global change in climate [@lenoir_svenning2015], environment [@morrison_etal2021; @seidl_etal2017], and human impact [@schmid_schiffels2023; @stehphens_etal2019]. This is largely facilitated through the ongoing digitization efforts and increased availability of Open Data in large-scale research data infrastructures [@buckland_sjolander2022; @page_etal2015; @tresp_etal2016; REFS]. 

In modern times there has been an observed decline in insect biodiversity [@hallman_etal2017; @schachat_labandeira2020; @vanklink_etal2020] a phenomenon which has been attributed to the intensification of agriculture [@habel_etal2019]; @raven_wagner2021]. The anthropogenic influence on insect biodiversity is not new, however, and has not always been a negative (at least for the insects) [@pilotto_etal2022; REFS]. It is still unknown whether the modern-day decline is a global phenomenon, and there is a need for further understanding of how insect community changes are affected by the modern-day anthropogenic impact (Luke et al. 2023). Certainly, a better understanding of how human impact has affected past insect communities will be valuable to assess the outcomes of future actions.   

# Aims

The aim of this paper is to study biodiversity trends of Coleoptera during periods of biotic transitions in the area of the United Kingdom (UK) and Ireland during the Late Glacial - Holocene period. Outside of systematic reviews of digitized and available data [e.g. @buckland2014; REF], large-scale palaeoenvironmental studies of subfossil insect data are rare. This paper presents a unique analysis and evaluation of biodiversity trends of the data available in the currently largest database of subfossil finds of Coleoptera, the Strategic Environmental Archaeology Database (SEAD).  


# Materials and Methods

The analysis is based on data retrieved from the BugsCEP constituent database (https://bugscep.com) [@buckland_buckland2006] of the open access Strategic Environmental Archaeology Database (SEAD; [sead.se](https://sead.se)) [@buckland_etal2018]. The study area includes the United Kingdom and Ireland during the Late Glacial - Holocene period, which has good coverage within the database [browser.sead.se/palaeoentomology](https://browser.sead.se/palaeoentomology). The study includes a total of `r nrow(sites_eu)` sites from which `r nrow(samples_brit)` samples have been collected. All of the samples come from natural deposits, with little to no signs of direct human influence (e.g. peat bogs, lakes) (@fig-sites-overview).

SEAD includes data generated by a variation of dating methods (e.g. radiometric, archaeological periods), with different levels of uncertainty, and have been harmonised to years Before Present (BP) to enable aggregated spatiotemporal analysis (REF). Samples that feature large age ranges, whether the result of long periods of accumulation or uncertainty, contribute noise to the data and make it difficult to discern short-term changes. Therefore, the dataset was filtered temporally, according to the process outlined in [@pilotto_etal2022]. Any samples with a mid-point that dated older than 16 000 years BP, and with an age range larger than 2 000 years, were excluded from the study. In adhering to the same filtering process, it likewise makes comparisons with the results from Pilotto et al.’s study of biotic transitions in Coleopteran communities possible. 

Analysis was performed in the R statistical open-source software [ver. 4.4.2; @rcore2021]. For temporal comparisons the study period was divided into 500-year bins and each sample was assigned to the bins they intersect using IRanges() from the Bioconductor package [@lawrence_etal2013]. Alpha, beta and gamma diversity metrics were calculated using a suite of ecological R packages. Each sample represents a single community, meaning that alpha diversity is defined on a sample basis. Gamma diversity represents the summed diversity of all samples that intersect a 500-year bin. Beta diversity, i.e. the change across time, is primarily analysed based on the aggregated community data (i.e. comparisons between 500-year bins). 

Diversity metrics include species richness, Shannon and Simpson diversity, and species turnover. Species richness was calculated using the vegan package [@oksanen_etal2024].  with remaining alpha and gamma metrics calculated using the entropart package [@marcon_herault2015]. The entropart package offers a number of estimation bias-correction methods to address mathematical issues with certain indexes (e.g. Shannon) and unobserved species. For this study the default unveiled estimators (“UnveilJ”) based on @chao_jost2015 and @marcon2015 were used, which includes jackknife for species richness estimation. Species turnover was calculated using Rank Abundance Curves (RAC) from the *codyn* package [@hallett_etal2020].

The analysis compares both raw abundances and standardized values. Rarefaction is a common standardization method for samples with variable sample depth in ecology [@sanders1968]. Effectively, individuals are discarded randomly from samples larger than the threshold set by the analyst. This method has received criticism, however, for its poor reproducibility and issues related to unequal sample sizes [@mcmurdie_holmes2014; @willis2019]. An alternative to rarefaction is Scaling with Ranked Subsampling *SRS), which like rarefaction scales the dataset based on a threshold set by the analyst, but preserves the population structure [@beule_karlovsky2020]. SRS was chosen as the primary standardization method for this study.  

In both rarefaction and SRS a threshold (Cmin) must be set for the new sample depth (abundance of individuals). Typically the smallest sample is used as the threshold, which would be unsuitable in this case as that is 1 individual. The threshold needs to be high enough to produce a suitably diverse community, but low enough that the size of the dataset is not impacted too severely. Most samples feature between 5 – 10 individuals, meaning a higher threshold will exclude a large portion of the dataset. With this in mind, Cmin was set to 10 for the analysis. Standardization was performed using the *SRS* package [@heidrich_etal2021].

The RAC function generates visualisations that compare the change in number and abundance of species between pairs of years (in this case 500-year bins) [@avolio_etal2019]. That is to say, each time bin is compared with the preceding one during analysis. RAC calculates five different metrics: species richness, evenness, rank change (change in species rank order), species turnover: gains, species turnover: losses. 

Environmental reconstructions were performed according to the BugsCEP procedure [@buckland2007,:101-117]. The data was summarised for each 500-year bin a sample intersected and standardised across each habitat type. The standardization shows each habitat as a proportion of the sum of environments included in the analysis (%SumRep). It is important to note that each taxa may be counted for more than one habitat. Two separate reconstructions were generated and evaluated; one that is based on presence only counts of taxa and one that is abundance weighted. 


# Results

 \linebreak

```{r}
#| label: fig-sites-overview
#| cache: true
#| aspect-ratio: 1
#| fig.align: "center"
#| out.height: "2400"
#| out.width: "2400px"
#| fig-cap: !expr 'paste("Distribution of sites with samples from natural deposits within Europe (n = ", nrow(sites_eu), ") filtered to the temporal range of the study. Most of the sites (n =", nrow(sites_brit), ") are located within the study area of the United Kingdom and Ireland.")'

quietly(source(here::here("analysis", "paper", "001-sites-overview-britain.R"), encoding = "UTF-8"))
knitr::include_graphics(here::here("analysis", "figures", "001-sites-overview-britain.jpg"), error = FALSE)
```


 \linebreak
 
The Bugs dataset in SEAD is biased towards NW Europe, and in particular the British Isles (Figure 1) (Buckland 2014). Of the 143 European sites that matched the requirements, ~ 75% are located within the United Kingdom and Ireland. Temporally there is a bimodal distribution of the data, with the Late Glacial (14 000 - 10 000 BP) and Subboreal - Subatlantic period  (5 500 - 2000 BP) being better represented at all sampling levels (site - sample - taxa abundance) (Figure 2; Supplementary XX). The first half of the Holocene is comparatively underrepresented in the data.

 \linebreak

```{r}
#| label: fig-sample-dates
#| cache: true
#| aspect-ratio: 1
#| fig.align: "center"
#| out.height: "1800px"
#| out.width: "2400px"
#| fig-cap: "a) Summary of sites, samples and total abundance for each 500-year bin between 16 000 BP and the modern day. The data is bimodally distributed across the study period, with peaks around the Late glacial and the last ~ 5 000 years. The decrease in datasets that cover 10 000 – 6 000 BP highlights a need for research and data submissions. b) Sample age ranges for the samples from the United Kingdom and Ireland, ordered from oldest to youngest. "

quietly(source(here::here("analysis", "paper", "001-sample-date-distribution-britain.R"), encoding = "UTF-8"))
knitr::include_graphics(here::here("analysis", "figures", "001-sample-site-abundance-summary.jpg"), error = FALSE)
```

 \linebreak

Although most samples intersect between 1 - 3 time bins, there is a small subset that are counted for up to 5 bins (see Supplementary XX). …Input from Francesca regarding how analysis age ranges were calculated in SEAD…Might be that the dating information is at a site level, and then applied to samples…not sure. 


## Late Glacial (ca. 16 000 – 11 500 Years BP)

The observed species richness (raw values) shows a steady increase across the Late Glacial period, with a clear decline when entering the Early Holocene (Figure 3). The estimated coverage, i.e. the probability that an individual belongs to a known species in the 500-year bin, is high (0-8 - 0.9) for most of the period. The average sample richness likewise shows a steady increase across the Late Glacial, both in raw and standardized values (Figure 4). The biggest differences can be seen at ca. 16 000 years BP, which features more sparse sampling, with lower counts of species and abundance of individuals than when compared to the later 500-year bins (Supplementary XX). With this in mind, standardized species richness indicates an initial decline that then stabilises throughout the Late Glacial period. 

The alpha diversity, i.e. average sample diversity, shows little variation in the raw abundance data throughout the Late Glacial (Figure 5). There is a slight decline in the effective number of species (incl. common (Shannon) and abundant (Simpson) species) ca. 14 000 years BP, after which the diversity remains largely steady up until the Holocene period. The standardized data, however, shows a different pattern (Figure 6). Although effective species richness steadily increases across the Late Glacial period, the number of common and abundant species shows an initial decline. It is only following ca. 12 500 years BP that there is a steady increase in common and abundant species, before the start of the Holocene period.

A similar development of species richness can be seen in the gamma diversity of the British Isles (Figure 7). There is a steady increase in the effective number of species from 16 000 years BP, peaking towards the end of the Late Glacial (ca. 11 500 years BP). 


 \linebreak

```{r}
#| label: fig-coverage
#| cache: true
#| aspect-ratio: 1
#| fig.align: "center"
#| out.height: "2600px"
#| out.width: "1800px"
#| fig-cap: "Coverage and richness estimation using bias-correction. Observed Richness is the total abundance of unique species found within each 500-year bin. Coverage estimates the completeness of the 500-year bin, i.e. the proportion of individuals belonging to the observed species. Estimated Richness shows the extrapolated richness using Chao (1984) correction."

quietly(source(here::here("analysis", "paper", "002-richness-estimation-britain.R"), encoding = "UTF-8"))
knitr::include_graphics(here::here("analysis", "figures", "002-richness-estimation-britain.jpg"), error = FALSE)
```

 \linebreak

```{r}
#| label: fig-richness
#| cache: true
#| aspect-ratio: 1
#| fig.align: "center"
#| out.height: "2600px"
#| out.width: "1800px"
#| fig-cap: "Comparison of species richness using raw, rarefied, and SRS standardized values. Mean richness for each age bin is calculated based on all samples that intersect a 500-year bin. Standard error represented as a grey ribbon. Cmin for rarefaction and SRS is 10 individuals per sample."

quietly(source(here::here("analysis", "paper", "002-richness-comparison-britain.R"), encoding = "UTF-8"))
knitr::include_graphics(here::here("analysis", "figures", "002-richness-comparison-britain.jpg"), error = FALSE)
```

 \linebreak

```{r}
#| label: fig-alpha-raw
#| cache: true
#| aspect-ratio: 1
#| fig.align: "center"
#| out.height: "2600px"
#| out.width: "1800px"
#| fig-cap: "Hill numbers of alpha diversity (effective number of species) for each 500-year time bin based on raw abundance values. The value represents the mean diversity of all samples (weighted by abundance) that intersect a time bin. Richness = effective species richness, Shannon = effective number of common species, Simpson = effective number of abundant species."

quietly(source(here::here("analysis", "paper", "002-alpha-diversity-britain-raw.R"), encoding = "UTF-8"))
knitr::include_graphics(here::here("analysis", "figures", "002-alpha-diversity-britain-raw.jpg"), error = FALSE)
```

 \linebreak

## Early Holocene (ca. 11 500 – 6 000 Years BP)

The Early Holocene period is characterised by an overall lower species richness than the Late Glacial period. Despite this the overall estimated coverage for the period remains fairly high, around 0.6 - 0.7, reaching  its peak at 8 500 years BP. These results need to be considered with the biased sampling in mind, however (Figure 2). The entire Early Holocene period is covered by a total of 39 samples that intersect at least one of 500-year time bins. This can be contrasted with the preceding Late Glacial period that includes 159 samples, or the Late Holocene with 316 samples. 

Although the observed richness is low, the standardized richness reflects a different pattern (Figure 4). The standardized species richness shows an increase at 10 000 years BP, compared to adjacent 500-year bins. A second peak in species richness also occurs at 8 500 - 8 000 BP. It is worth highlighting that 8 000 BP features the lowest abundance values for the dataset (Supplementary XX). 

This decline is expected based on the overall lower sampling for the 10 000 - 6 000 BP period (Figure 2). 


Both of these 500-year bins are characterised by loss of species from the preceding bin (Figure 8), along with a decrease in species richness (Figure 3). This changes once standardized according to both rarefaction and SRS.  

 \linebreak

```{r}
#| label: fig-alpha-srs
#| cache: true
#| aspect-ratio: 1
#| fig.align: "center"
#| out.height: "2600px"
#| out.width: "1800px"
#| fig-cap: "Hill numbers of alpha diversity (effective number of species) for each 500-year time slice based on SRS standardized values. The value represents the mean diversity of all samples (weighted by abundance) that intersect a time bin. Richness = effective species richness, Shannon = effective number of common species, Simpson = effective number of abundant species."

quietly(source(here::here("analysis", "paper", "002-alpha-diversity-britain-srs.R"), encoding = "UTF-8"))
knitr::include_graphics(here::here("analysis", "figures", "002-alpha-diversity-britain-srs.jpg"), error = FALSE)
```

 \linebreak

```{r}
#| label: fig-gamma
#| cache: true
#| aspect-ratio: 1
#| fig.align: "center"
#| out.height: "4200px"
#| out.width: "3300px"
#| fig-cap: " Hill numbers of gamma diversity (effective number of species) for each 500-year time slice, calculated on both raw abundance and SRS standardized values. Each value represents the total diversity (samples abundance weighted) for each time bin. Richness = effective species richness, Shannon = effective number of common species, Simpson = effective number of abundant species."

quietly(source(here::here("analysis", "paper", "002-gamma-diversity-britain.R"), encoding = "UTF-8"))
knitr::include_graphics(here::here("analysis", "figures", "002-gamma-diversity-britain.jpg"), error = FALSE)
```

 \linebreak

```{r}
#| label: fig-rac
#| cache: true
#| aspect-ratio: 1
#| fig.align: "center"
#| out.height: "4200px"
#| out.width: "3300px"
#| fig-cap: "Rank Abundance Curves (RAC) calculated on raw values from the British Isles (Avolio et al. 2019). Calculations are made on the summed abundances of all samples that intersect a 500-year time bin. In RAC the change in five parameters of community change (Species richness, Rank abundance, Evenness, Species gain, Species loss) is analysed between two time points."

quietly(source(here::here("analysis", "paper", "004-rank-abundance-curves-britain.R"), encoding = "UTF-8"))
knitr::include_graphics(here::here("analysis", "figures", "004-rank-abundance-curves-britain.jpg"), error = FALSE)
```

 \linebreak

## Late Holocene (6 000 – 500 BP)


```{r}
#| label: fig-eco
#| cache: true
#| aspect-ratio: 1
#| fig.align: "center"
#| out.height: "2100px"
#| out.width: "1500px"
#| fig-cap: "Habitat reconstruction based on samples from natural deposits in the United Kingdom and Ireland. Species and abundance data has been summed and calculated for each 500-year bin a sample intersects. Habitat reconstructions are based on the BugsCEP ecocodes (Buckland 2007:102), visualised both as abundance weighted and species only reconstruction."

quietly(source(here::here("analysis", "paper", "005-ecocodes-britain.R"), encoding = "UTF-8"))
knitr::include_graphics(here::here("analysis", "figures", "005-ecocodes-britain.jpg"), error = FALSE)
```

 \linebreak

```{r}
#| label: fig-eco-terr
#| cache: true
#| aspect-ratio: 1
#| fig.align: "center"
#| out.height: "2100px"
#| out.width: "1500px"
#| fig-cap: "Habitat reconstruction focused on terrestrial environments. Species and abundance data has been summed and calculated for each 500-year bin a sample intersects. Habitat reconstructions are based on the BugsCEP ecocodes (Buckland 2007:102), visualised both as abundance weighted and species only reconstruction."

quietly(source(here::here("analysis", "paper", "005-ecocodes-terrestrial-britain.R"), encoding = "UTF-8"))
knitr::include_graphics(here::here("analysis", "figures", "005-ecocodes-terrestrial-britain.jpg"), error = FALSE)
```


```{r}
#| label: fig-corr-test
#| cache: true
#| aspect-ratio: 1
#| fig.align: "center"
#| out.height: "2100px"
#| out.width: "1500px"
#| fig-cap: "Habitat reconstruction focused on terrestrial environments. Species and abundance data has been summed and calculated for each 500-year bin a sample intersects. Habitat reconstructions are based on the BugsCEP ecocodes (Buckland 2007:102), visualised both as abundance weighted and species only reconstruction."

quietly(source(here::here("analysis", "paper", "006-ecocodes-britain.R"), encoding = "UTF-8"))
quietly(source(here::here("analysis", "paper", "007-oxygen-corr-script.R"), encoding = "UTF-8"))
quietly(source(here::here("analysis", "paper", "pollen_richness_wip.R"), encoding = "UTF-8"))

eco_results <- results_filtered %>% 
  filter(method == "Abundance-weighted")

p_eco <- ggplot(eco_results, aes(x = bin, y = value, fill = ecocode)) +
  geom_bar(
    stat = "identity",
    position = "stack",
    alpha = 0.9,
    just = 0
    ) +
  scale_fill_manual(values = colors, name = "Habitat") +
  guides(fill = guide_legend(nrow = 5, reverse = TRUE)) +
  scale_x_reverse(breaks = time_breaks, labels = time_breaks) +  
  labs(
    title = "Habitat reconstruction",
    subtitle = "Abundance-weighted",
    x = "",
    y = "%SumRep"
  ) +
  coord_flip() +
  theme_bw() +
  theme(
    plot.title    = element_text(size = 16, face = "bold", colour = "black"),
    axis.text.y = element_blank(),
    axis.title.x = element_text(size = 12, face = "bold"),
    strip.text = element_text(size = 14, face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12),
  ) +
  labs(y = "%SumRep", x = "")


## 1) Build LEFT block with collected legend (temporarily visible)
left_group_with_legend <- (p_div + p_eco) +
  plot_layout(ncol = 2, widths = c(1, 0.6), guides = "collect") &
  theme(
    legend.position      = "bottom",
    legend.justification = "center",
    legend.box.just      = "center"
  )

## 2) Extract the legend grob from the left block
left_legend <- cowplot::get_legend(left_group_with_legend)

## 3) Turn the legend grob into a plot we can place in patchwork
legend_row <- cowplot::ggdraw(left_legend)

## 4) Make a version of the left block WITHOUT its legend (so we don’t duplicate)
left_group <- (p_div + p_eco) +
  plot_layout(ncol = 2, widths = c(1, 0.6), guides = "collect") &
  theme(legend.position = "none")

## 5) Build RIGHT block (p_pollen keep top legend; p_d18 as-is)
right_group <- (p_pollen + theme(legend.position = "top")) + p_d18 +
  plot_layout(ncol = 2, widths = c(1, .9))

## 6) Final compose:
combined <- (left_group | right_group) + plot_layout(widths = c(1, .7))  

combined <- combined / legend_row + plot_layout(heights = c(1, .2))

# Save combined figure
ggsave(
  filename = "007-gamma-eco-d18o.jpg",
  plot     = combined,
  path     = fig_dir,
  width = 50,
  height = 40,
  units = "cm",
  dpi = 500
)

```


 \linebreak

# Discussion

# Conclusion

# Acknowledgements

<!-- The following line inserts a page break  -->

\newpage

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::

\newpage

### Colophon

This report was generated on `r Sys.time()` using the following computational environment and dependencies:

```{r}
#| label: colophon
#| cache: false

# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
